<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dust My Groom</title>
  <link rel="stylesheet" href="app.css">
</head>

<body>
  <div id="app"></div>
  <script src="bundle.js"></script>
  <script src="https://www.gstatic.com/firebasejs/3.4.1/firebase.js"></script>
  <script>
  var app = Elm.Main.embed(document.getElementById("app"))
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyBty8SUQvWPywPS4lwyZSs_9JsQMoMksHM",
      authDomain: "dust-my-groom.firebaseapp.com",
      databaseURL: "https://dust-my-groom.firebaseio.com",
      storageBucket: "dust-my-groom.appspot.com",
      messagingSenderId: "105795449472"
    };
    firebase.initializeApp(config);
    var database = firebase.database();


    // current story
    var currentStoryRef = database.ref().child('currentStory')
    app.ports.startStorySizing.subscribe(function(storyName) {
      console.log ('start sizing', storyName)
      currentStoryRef.set(storyName);
    })

    currentStoryRef.on('value', function(currentStory) {
      console.log("currentStory", currentStory.val())
      var storyName = currentStory.val();
      if(storyName) {
        app.ports.storySizingStarted.send(storyName)
      } else {
        app.ports.storySizingEnded.send("")
      }

    })

    // votes
    var votesRef = database.ref().child('votes')
    app.ports.vote.subscribe(function(vote) {
      console.log ('vote submitted', vote)
      votesRef.push(vote)
    })

    votesRef.on('child_added', function(vote) {
      console.log("vote added", vote.val())
      app.ports.voteAdded.send(vote.val())
    })

    // votesRef.on('value', function(votes) {
    //   console.log("votes changed", votes.val())
    //   if(votes.val() === null){
    //     // TODO set model.votes to []
    //   }
    // })




    app.ports.saveSizedStory.subscribe(function(story) {
      console.log ('story sized', story)
      votesRef.set(null)
      saveStory(story)
      currentStoryRef.set(null);
    })

    function saveStory(story) {
      app.ports.sizedStorySaved.send(story)
    }

  </script>
</body>

</html>
